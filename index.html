<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Pub-Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;800&family=Bangers&family=Permanent+Marker&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:
        radial-gradient(1200px 600px at 10% -10%, #ffe7a6aa, transparent),
        radial-gradient(1000px 500px at 110% 110%, #a7f3d088, transparent),
        linear-gradient(120deg, #fdfcfb, #eef2ff);

      --bg-single: linear-gradient(90deg, #f769f9 0%, #6ab7fb 100%);
      --bg-team:   linear-gradient(90deg, #6ab7fb 0%, #f769f9 100%);

      --card:#ffffff;
      --muted:#475569;
      --good:#16a34a;
      --bad:#dc2626;
      --blue-soft:#eaf2ff;
      --blue-soft-border:#c7ddff;
      --title:#0f172a;
      --correct:#ef4444;
      --winner:#fde047;
      --reveal-bg:#d1fae5;
      --reveal-border:#34d399;
      --reveal-text:#000000;

      /* Auswahlring-Farbe für angeklickte Buttons (A..F / 1..6) */
      --select-ring:#3dffff; /* z.B. #22c55e80 für grün mit Transparenz */
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Rubik',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a;overflow-x:hidden}
    .screen{min-height:100%;display:none;padding:24px}
    .show{display:block}
    .theme-start{background:var(--bg-start)}
    .theme-single{background:var(--bg-single); color:#f8fafc}
    .theme-team{background:var(--bg-team); color:#f8fafc}
    .wrap{max-width:1100px;margin:0 auto}

    .btn{border:none;border-radius:999px;padding:14px 18px;font-size:18px;cursor:pointer;box-shadow:0 8px 22px #00000012;transition:transform .05s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#ef4444;color:#fffb00;font-family:'Bangers',cursive;letter-spacing:.5px;font-size:24px}
    .btn-ghost{background:#f1f5f9;color:#0f172a;border-radius:12px}
    .btn-outline{background:transparent;border:2px solid currentColor}
    .btn-good{background:var(--good);color:#fff}
    .btn-bad{background:var(--bad);color:#fff}
    .btn-reveal{
      background:var(--reveal-bg); color:var(--reveal-text);
      border:2px solid var(--reveal-border); border-radius:14px;
      font-family:'Permanent+Marker',cursive; font-size:22px; font-weight:800; letter-spacing:.2px;
    }

    .title{
      font-family:'Bangers',cursive; letter-spacing:1px;
      font-size:64px; line-height:1; margin:6px 0 8px; text-align:center; color:var(--title);
      text-shadow:0 2px 0 #fff
    }
    .theme-single .title,.theme-team .title{color:#fefefe;text-shadow:0 3px 12px #0008}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .topbar .right{display:flex;gap:8px}
    .card{background:var(--card);border-radius:18px;box-shadow:0 10px 30px #00000014;padding:20px}

    /* Modus-Kacheln */
    .mode-header{font-size:30px;text-align:center;margin:8px 0 14px; font-weight:600}
    .mode-row{display:flex; justify-content:center; gap:16px; align-items:flex-start; position:relative}
    .mode-tile{
      width:260px; border-radius:22px; padding:24px 16px;
      color:#fff; cursor:pointer; box-shadow:0 12px 28px #0002;
      transition:transform .12s, box-shadow .12s; text-align:center
    }
    .mode-tile:hover{transform:translateY(-2px); box-shadow:0 16px 34px #0003}
    .tile-single{background:linear-gradient(160deg,#0ea5e9,#2563eb)}
    .tile-team{background:linear-gradient(160deg,#22c55e,#15803d)}
    .mode-tile h3{margin:0; font-size:28px; font-weight:800}
    .mode-tile.selected{
      box-shadow: 0 0 0 4px #ef4444, 0 0 0 10px #facc15, 0 12px 28px #0002;
    }

    /* Team-Config Pane */
    #team-config{
      width:260px; display:none;
      background:rgba(34,197,94,0.32);
      border:1px solid rgba(34,197,94,0.6);
      border-radius:18px; box-shadow:0 10px 30px #00000014; padding:14px;
      position:absolute; top:0; left:calc(50% + 138px);
      transform:translateX(8px);
    }
    #team-config .label{font-weight:800; margin-bottom:6px; font-size:18px}
    #team-config .row{display:flex; gap:10px; align-items:center}
    #team-config input[type="number"]{
      max-width:140px; padding:12px 14px; border:1px solid #94a3b8; border-radius:12px;
      font-size:20px; height:48px;
    }

    /* Datei-Karte */
    .file-card{max-width:640px; margin:14px auto 0}
    .file-box{display:flex;flex-direction:column;align-items:center; gap:14px}
    #fileInput{display:block; padding:14px; border:2px dashed #94a3b8; border-radius:14px; font-size:18px; width:100%}

    /* Game-Header */
    .header{display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px; margin-bottom:10px}
    .header .title{grid-column:2/3; margin:0}
    .header-left{justify-self:start}
    .header-right{justify-self:end; display:flex; gap:8px; align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#00000033;color:#f8fafc;font-size:12px}
    #topic{font-size:40px;text-align:center;margin:8px 0 10px;color:#fff;text-shadow:0 2px 10px #0009;font-weight:800}

    .options-wrap{max-width:1000px;margin:0 auto;background:var(--blue-soft);border:1px solid var(--blue-soft-border);padding:16px;border-radius:16px}
    #question{font-size:36px;line-height:1.15;margin:6px 0 12px;text-align:center;color:#111}
    #options{max-width:900px;margin:0 auto}
    #options .opt{display:block;padding:12px 14px;border:2px solid #e2e8f0;border-radius:14px;margin:8px 0;font-size:20px;background:#fff;color:#0b0f19}
    .opt.correct{border-color:var(--correct);box-shadow:0 0 0 3px rgba(239,68,68,.35) inset}
    #options.grid-2x3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-auto-rows:1fr;gap:14px 16px}
    #options.grid-2x3 .opt{margin:0;display:flex;align-items:center}

    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}

    /* Scoreboard */
    .scoreboard{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .team{display:flex;align-items:center;gap:10px;border-radius:16px;padding:12px;box-shadow:0 8px 20px #00000018;cursor:pointer;transition:box-shadow .2s}
    .team.active{box-shadow:0 0 0 3px #fff,0 0 0 6px #00000033}
    .team.winner{outline:3px solid var(--winner);outline-offset:2px;background:rgba(253,224,71,.18)!important}
    .team-color{width:18px;height:18px;border-radius:50%}

    .points-badge{font-weight:900;background:#ffffffaa;color:#111;border-radius:10px;padding:4px 8px}
    .midbox{flex:1; display:flex; flex-direction:column; gap:6px; margin-left:6px; min-width:260px}
    .choice-box{display:flex;flex-direction:column;gap:6px}
    .choice-buttons{display:flex;gap:6px;flex-wrap:wrap}
    .choice-buttons.six{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .choice-btn{border:2px dashed #64748b;border-radius:12px;padding:6px 10px;background:#c2c2c2;font-size:14px;cursor:pointer;min-width:42px;text-align:center}
    .choice-btn.sel{border-style:solid;box-shadow:0 0 0 2px var(--select-ring)} /* Auswahlring */

    .seq{font-weight:800;font-size:14px}
    .seq small{opacity:.7}

    .footer-hint{opacity:.75;font-size:12px;margin-top:8px;text-align:center}
    .hidden{display:none}

    #winner-banner{display:none;margin:10px auto 0;text-align:center;background:linear-gradient(90deg,rgba(253,224,71,.9),rgba(254,240,138,.9));color:#1f2937;border-radius:14px;padding:10px 14px;font-weight:800;box-shadow:0 10px 30px #00000020;max-width:1000px}
    #winner-banner.show{display:block}

    /* Konfetti */
    #confetti{position:fixed;inset:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;display:none}
    #confetti.show{display:block}

    /* Zwischen-/Endstand */
    #standings{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9000}
    #standings.show{display:flex}
    .standings-card{width:min(900px,95vw);background:#fff;border-radius:16px;box-shadow:0 18px 50px rgba(0,0,0,.25);padding:18px}
    .standings-title{font-family:'Bangers',cursive;font-size:44px;margin:2px 0 10px;text-align:center;color:#111}
    .standings-list{position:relative}
    .standing-item{
      position:relative;background:#f1f5f9;border-radius:14px;padding:14px 16px;margin:8px 0;
      display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;
      box-shadow:0 10px 20px rgba(0,0,0,.08);transition:transform 1.2s ease, box-shadow .2s ease
    }
    .standing-rank{font-weight:900;font-size:20px;width:34px;text-align:center}
    .standing-name{font-weight:800}
    .standing-score{font-weight:900}
    .standing-item.winner{box-shadow:0 0 0 4px var(--winner), 0 8px 20px rgba(0,0,0,.1); background:rgba(253,224,71,.18)}
    .standings-actions{display:flex;justify-content:center;margin-top:10px;gap:10px}
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <!-- START -->
  <section id="screen-start" class="screen theme-start show">
    <div class="wrap">
      <div class="topbar">
        <div></div>
        <div class="right">
          <button class="btn btn-ghost" id="btn-fs-start" title="Vollbild umschalten">⛶ Vollbild</button>
        </div>
      </div>

      <div class="title">Pub-Quiz</div>
      <div class="mode-header">Modus wählen</div>

      <div class="mode-row">
        <div class="mode-tile tile-single" id="tile-single"><h3>Einzel</h3></div>
        <div class="mode-tile tile-team" id="tile-team"><h3>Team</h3></div>

        <div id="team-config">
          <div class="label">Teams</div>
          <div class="row">
            <input id="in-team-count" type="number" min="2" max="8" value="4" />
          </div>
          <button class="btn btn-ghost" id="btn-build-teams">Refresh</button>
          <div id="team-list"></div>
        </div>
      </div>

      <div class="card file-card">
        <div class="file-box">
          <label style="font-weight:600">Fragen-Datei (.txt)</label>
          <input type="file" id="fileInput" accept=".txt" />
          <button class="btn btn-primary" id="btn-start">Spiel starten</button>
        </div>
      </div>
    </div>
  </section>

  <!-- GAME -->
  <section id="screen-game" class="screen">
    <div class="wrap">
      <div class="header">
        <div class="header-left"><button class="btn btn-ghost btn-outline" id="btn-back">⟵ Menü</button></div>
        <div class="title">Pub-Quiz</div>
        <div class="header-right">
          <button class="btn btn-ghost" id="btn-fs-game" title="Vollbild umschalten">⛶ Vollbild</button>
          <span class="pill" id="pill-counter">0/0</span>
        </div>
      </div>

      <div id="winner-banner"></div>
      <div id="topic">Thema</div>

      <div class="options-wrap">
        <div id="question">Frage…</div>
        <div id="options"></div>
      </div>

      <div class="controls">
        <button class="btn btn-ghost" id="btn-prev">◀ Zurück</button>
        <button class="btn btn-reveal" id="btn-reveal">Auflösen</button>
        <button class="btn btn-primary" id="btn-next">Weiter ▶</button>
      </div>
      <div class="footer-hint">Leertaste: Auflösen · Pfeile: Zurück/Weiter · Esc: Vollbild</div>

      <div id="score-area" class="scoreboard hidden"></div>
    </div>
  </section>

  <!-- Zwischen-/Endbildschirm -->
  <div id="standings">
    <div class="standings-card">
      <div class="standings-title" id="standings-title">Zwischenstand</div>
      <div class="standings-list" id="standings-list"></div>
      <div class="standings-actions">
        <button class="btn btn-primary" id="standings-continue">Weiter</button>
        <button class="btn btn-ghost" id="standings-exit" style="display:none">Beenden</button>
      </div>
    </div>
  </div>

<script>
/* ========================== ANIM-CONFIG ========================== */
const STANDINGS_COUNT_MS = 1800;
const STANDINGS_FLIP_MS  = 1200;
const STANDINGS_PREP_MS  = 700;
const STANDINGS_AFTER_MS = STANDINGS_FLIP_MS + 20;

/* ========================== STATE ========================== */
const state={
  mode:null,              // 'single' | 'team'
  questions:[],
  idx:0,
  reveal:false,
  teams:[],
  committed:false,
  finished:false,
  scoresStartRound:[],
  activeTeamIndex:0
};
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const byId = id => document.getElementById(id);

/* ===== helpers ===== */
function fmtCounter(){ return (state.idx+1)+'/'+state.questions.length; }
function hexWithAlpha(hex,a){const m=hex.match(/^#([0-9a-f]{6})$/i);if(!m)return`rgba(0,0,0,${a})`;const n=parseInt(m[1],16);const r=(n>>16)&255,g=(n>>8)&255,b=n&255;return`rgba(${r},${g},${b},${a})`;}
function defaultColor(i){const p=['#ef4444','#3b82f6','#22c55e','#eab308','#a855f7','#06b6d4','#f97316','#84cc16'];return p[i%p.length];}

function parseRankAnswer(answerText, options) {
  if (!answerText) return null;
  const tokens = answerText.split(',').map(s => s.trim()).filter(Boolean);
  if (!tokens.length) return null;
  if (tokens.every(t => /^\d+$/.test(t))) {
    const idxs = tokens.map(n => parseInt(n,10)-1);
    if (idxs.every(i => i>=0 && i<options.length)) return idxs;
  }
  const map = new Map(options.map((opt, i) => [opt.text.trim(), i]));
  const idxs = [];
  for (const tok of tokens) {
    const idx = map.get(tok);
    if (idx == null) return null;
    idxs.push(idx);
  }
  return idxs.length ? idxs : null;
}

/* ========================== MODUS-AUSWAHL ========================== */
function selectMode(mode){
  state.mode = mode;
  byId('tile-single').classList.toggle('selected', mode==='single');
  byId('tile-team').classList.toggle('selected',   mode==='team');
  byId('team-config').style.display = (mode==='team') ? 'block' : 'none';
}
byId('tile-single').addEventListener('click',()=>selectMode('single'));
byId('tile-team').addEventListener('click',()=>selectMode('team'));

/* Teamnamen erzeugen */
byId('btn-build-teams').addEventListener('click',renderTeamInputs);
function renderTeamInputs(){
  const list=byId('team-list');
  const n=parseInt(byId('in-team-count').value||'4',10);
  list.innerHTML='';
  for(let i=0;i<n;i++){
    const row=document.createElement('div');
    row.className='row';
    row.innerHTML=
      `<input type="text" placeholder="Team ${i+1}" data-tname="${i}" />`+
      `<input type="color" value="${defaultColor(i)}" data-tcolor="${i}" />`;
    list.appendChild(row);
  }
}

/* ========================== START ========================== */
byId('btn-start').addEventListener('click',()=>{
  if(!state.mode){ alert('Bitte Modus wählen (Einzel oder Team).'); return; }

  if(state.mode==='team'){
    state.teams=[];
    const n=parseInt(byId('in-team-count').value||'4',10);
    const list=byId('team-list');
    for(let i=0;i<n;i++){
      const name=(list.querySelector(`input[data-tname="${i}"]`)||{}).value||('Team '+(i+1));
      const color=(list.querySelector(`input[data-tcolor="${i}"]`)||{}).value||defaultColor(i);
      state.teams.push({name,color,score:0,choices:new Set(),rankSeq:[]});
    }
    state.activeTeamIndex=0;
  } else {
    state.teams=[];
  }

  state.reveal=false; state.committed=false; state.finished=false;

  const file = byId('fileInput').files[0];
  if(file){
    const r=new FileReader();
    r.onload=ev=>{ parseQuestions(ev.target.result); showGame(); };
    r.readAsText(file,'UTF-8');
  }else{
    parseQuestions(sampleText());
    showGame();
  }
});

function setThemeForGame(){
  const g=byId('screen-game');
  g.classList.remove('theme-single','theme-team');
  g.classList.add(state.mode==='team'?'theme-team':'theme-single');
}

/* Show Game */
function showGame(){
  byId('screen-start').classList.remove('show');
  byId('screen-game').classList.add('show');
  setThemeForGame();
  snapshotScores();
  renderQuestion();
  renderWinnerBanner();
}

/* Zurück ins Menü */
byId('btn-back').addEventListener('click',resetAll);

/* ========================== DATEI ========================== */
byId('fileInput').addEventListener('change',()=>{});

/* ========================== PARSER ========================== */
function isKey(line){const s=line.trim();return /^TYPE:|^TAG:|^\*?OPT:|^ANSWER:|^POINTS:|^TIMER:|^Q:/.test(s);}
function splitBlocks(text){return text.split(/\n\s*\n+/);}

function parseQuestions(content){
  try{
    const text=(content||'').replace(/\r\n?/g,'\n').trim();
    if(!text){ state.questions=[]; return; }
    const blocks=splitBlocks(text), qs=[];
    for(const block of blocks){
      const obj={type:'open',tag:'Allgemein',text:'',options:[],answer:'',points:1,timer:null,shuffle:null,rankAnswer:null};
      const lines=block.split('\n');
      for(let i=0;i<lines.length;i++){
        const line=lines[i].trim();
        if(line.startsWith('TYPE:')){
          const raw=line.slice(5).trim().toLowerCase();
          obj.type = (/^(rank|ranking|order|sort)$/.test(raw)) ? 'rank' : raw;
        }
        else if(line.startsWith('TAG:')) obj.tag=line.slice(4).trim()||'Allgemein';
        else if(line.startsWith('POINTS:')) obj.points=parseInt(line.slice(7).trim()||'1',10)||1;
        else if(line.startsWith('TIMER:')) obj.timer=parseInt(line.slice(6).trim()||'0',10)||null;
        else if(line.startsWith('Q:')){
          let q=line.slice(2).trim();
          while(i+1<lines.length && !isKey(lines[i+1])){ i++; q+=(q?'\n':'')+lines[i]; }
          obj.text=q.trim();
        }
        else if(line.startsWith('*OPT:')||line.startsWith('OPT:')){
          const correct = line.startsWith('*OPT:');
          const t = line.slice(correct ? 5 : 4).trim();
          if (obj.type !== 'rank') obj.type = 'mc';
          obj.options.push({ text: t, correct });
        }
        else if(line.startsWith('ANSWER:')) obj.answer=line.slice(7).trim();
      }
      if (obj.type === 'rank') {
        obj.rankAnswer = parseRankAnswer(obj.answer, obj.options) || obj.options.map((_,i)=>i);
      }
      if(obj.text) qs.push(obj);
    }
    state.questions=qs;
    state.idx=0; state.reveal=false; state.committed=false; state.finished=false;
    byId('pill-counter').textContent=fmtCounter();
    snapshotScores();
    renderQuestion();
  }catch(err){
    console.error(err);
    alert('Fehler beim Lesen der Fragen.');
    state.questions=[];
  }
}

/* ========================== RENDER ========================== */
function renderWinnerBanner(msg){
  const wb=byId('winner-banner');
  if(msg){wb.textContent='👑 '+msg+' 👑'; wb.classList.add('show');}
  else {wb.textContent=''; wb.classList.remove('show');}
}

function renderQuestion(){
  const q=state.questions[state.idx];

  if(!state.finished) renderWinnerBanner();

  if(!q){
    byId('topic').textContent='—';
    byId('question').textContent='(Keine Fragen geladen)'; byId('options').innerHTML='';
    byId('score-area').classList.add('hidden');
    return;
  }

  byId('topic').textContent=q.tag||'Thema';
  byId('pill-counter').textContent=fmtCounter();
  byId('question').textContent=q.text||'';

  renderOptionsOnly(q);
  renderScoreboard(q);
}

function renderOptionsOnly(q){
  const optDiv=byId('options');
  optDiv.classList.remove('grid-2x3');
  optDiv.innerHTML='';

  if(q.type==='mc' && q.options.length){
    const N=Math.min(q.options.length,6);
    if(N===6) optDiv.classList.add('grid-2x3');
    for(let i=0;i<N;i++){
      const d=document.createElement('div');
      d.className='opt';
      d.textContent=String.fromCharCode(65+i)+') '+q.options[i].text;
      optDiv.appendChild(d);
    }
    if(state.reveal){
      const opts=optDiv.children;
      for(let i=0;i<N;i++) if(q.options[i].correct) opts[i].classList.add('correct');
    }
  }
  else if(q.type==='rank' && q.options.length){
    const N = Math.min(q.options.length, 6);
    // Keine Zufallsmischung – Anzeige = Reihenfolge aus der TXT
if (!q.shuffle) {
  q.shuffle = [...q.options.keys()];
}

    const order = state.reveal ? q.rankAnswer.slice(0,N) : q.shuffle.slice(0,N);
    if(N===6) optDiv.classList.add('grid-2x3');
    order.forEach((optIdx)=>{
      const d=document.createElement('div');
      d.className='opt';
      d.textContent = q.options[optIdx].text;
      optDiv.appendChild(d);
    });
  }
  else{
    const d=document.createElement('div'); d.className='opt'; d.id='open-box';
    d.textContent = state.reveal ? (q.answer && q.answer.trim()? q.answer : '—') : 'Schreibt eure Antwort auf!';
    optDiv.appendChild(d);
  }
}

/* Scoreboard */
function renderScoreboard(q){
  const area=byId('score-area'); area.innerHTML='';
  if(state.mode!=='team'){ area.classList.add('hidden'); return; }
  area.classList.remove('hidden');

  const isMC = q && q.type==='mc' && q.options.length;
  const isRank = q && q.type==='rank' && q.options.length;
  const N = q && q.options ? Math.min(q.options.length,6) : 0;

  state.teams.forEach((team,idx)=>{
    const row=document.createElement('div'); row.className='team'; row.style.background=hexWithAlpha(team.color,.32);
    if(state.activeTeamIndex===idx) row.classList.add('active');
    row.addEventListener('click',()=>{ state.activeTeamIndex=idx; renderScoreboard(q); });

    const dot=document.createElement('div'); dot.className='team-color'; dot.style.background=team.color;
    const name=document.createElement('div'); name.textContent=team.name;
    const points=document.createElement('div'); points.className='points-badge'; points.textContent=team.score+' Pkt.';

    const mid=document.createElement('div'); mid.className='midbox';
    const choiceBox=document.createElement('div'); choiceBox.className='choice-box';

    if(isMC){
      const letters=Array.from({length:N},(_,i)=>String.fromCharCode(65+i));
      const btns=document.createElement('div'); btns.className='choice-buttons'; if(N>4) btns.classList.add('six');
      letters.forEach(L=>{
        const b=document.createElement('button'); b.className='choice-btn'; b.textContent=L;
        if(team.choices.has(L)) b.classList.add('sel');
        b.addEventListener('click',()=>{ team.choices.has(L)?team.choices.delete(L):team.choices.add(L); renderScoreboard(q); });
        btns.appendChild(b);
      });
      choiceBox.appendChild(btns);
    }

    if(isRank){
      const nums=document.createElement('div'); nums.className='choice-buttons'; if(N>4) nums.classList.add('six');
      for(let i=1;i<=N;i++){
        const b=document.createElement('button'); b.className='choice-btn'; b.textContent=String(i);
        if(team.rankSeq.includes(i)) b.classList.add('sel');
        b.addEventListener('click',()=>{ pushRank(idx,i,N); });
        nums.appendChild(b);
      }
      const seq=document.createElement('div'); seq.className='seq';
      seq.innerHTML=`<small>Reihenfolge:</small> ${team.rankSeq.join(' → ')||'—'}`;
      choiceBox.appendChild(nums);
      choiceBox.appendChild(seq);
    }

    mid.appendChild(choiceBox);

    const ctrl=document.createElement('div'); ctrl.style.display='flex'; ctrl.style.gap='6px'; ctrl.style.marginLeft='auto';
    const plus=document.createElement('button'); plus.className='btn'; plus.style.background='#16a34a'; plus.style.color='#fff'; plus.textContent='+1';
    plus.title='+1'; plus.addEventListener('click',()=>{ team.score+=1; points.textContent=team.score+' Pkt.'; });
    const minus=document.createElement('button'); minus.className='btn'; minus.style.background='#dc2626'; minus.style.color='#fff'; minus.textContent='-1';
    minus.title='−1'; minus.addEventListener('click',()=>{ team.score=Math.max(0,team.score-1); points.textContent=team.score+' Pkt.'; });
    ctrl.appendChild(plus); ctrl.appendChild(minus);

    row.appendChild(dot);
    row.appendChild(name);
    row.appendChild(points);
    row.appendChild(mid);
    row.appendChild(ctrl);

    area.appendChild(row);
  });
}

/* Ranking helpers */
function pushRank(teamIdx,num,N){
  const team=state.teams[teamIdx];
  if(team.rankSeq.includes(num)) return;
  if(team.rankSeq.length>=N) return;
  team.rankSeq.push(num);
  renderScoreboard(state.questions[state.idx]);
}
function pushRankForActiveTeam(num,N){
  if(state.activeTeamIndex==null) return;
  pushRank(state.activeTeamIndex,num,N);
}
function undoRankForActiveTeam(){
  if(state.activeTeamIndex==null) return;
  const t=state.teams[state.activeTeamIndex];
  t.rankSeq.pop();
  renderScoreboard(state.questions[state.idx]);
}
function clearRankForActiveTeam(){
  if(state.activeTeamIndex==null) return;
  const t=state.teams[state.activeTeamIndex];
  t.rankSeq.length=0;
  renderScoreboard(state.questions[state.idx]);
}

/* Snapshot vor Frage (für ZB) */
function snapshotScores(){
  state.scoresStartRound = state.teams.map(t=>t.score);
}

/* ========================== REVEAL & SCORING ========================== */
byId('btn-reveal').addEventListener('click', ()=>{
  const q = state.questions[state.idx];
  if (!q) return;

  state.reveal = !state.reveal;

  if (state.reveal) {
    // REVEAL
    if (q.type === 'mc') {
  const N = Math.min(q.options.length, 6);
  const opts = byId('options').children;
  for (let i = 0; i < N; i++) {
    if (q.options[i].correct) opts[i].classList.add('correct');
  }

  if (state.mode === 'team' && !state.committed) {
    // Nur bei Mehrfachauswahl bestrafen: "(Mehrfachauswahl)" muss im Fragetext stehen
    const isMulti = /\(Mehrfachauswahl\)/i.test(q.text || '');

    const correctLetters = new Set();
    const allLetters = new Set([...Array(N)].map((_, i) => String.fromCharCode(65 + i))); // A..F
    for (let i = 0; i < N; i++) {
      if (q.options[i].correct) correctLetters.add(String.fromCharCode(65 + i));
    }

    for (const team of state.teams) {
      let tp = 0; // richtige Picks
      let fp = 0; // falsche Picks

      if (team.choices && team.choices.forEach) {
        team.choices.forEach(L => {
          if (!allLetters.has(L)) return;
          if (correctLetters.has(L)) tp++;
          else fp++;
        });
      }

      let delta = 0;
      if (isMulti) {
        // Punkte: +POINTS je richtige Auswahl, -1 je falscher Auswahl
        delta = tp * (q.points || 1) - fp * 1;
      } else {
        // Einzelwahl: bleibt wie gehabt – ein richtiger Pick gibt +POINTS, falsche ignorieren
        delta = tp > 0 ? (q.points || 1) : 0;
      }

      if (delta !== 0) {
        team.score = Math.max(0, team.score + delta); // kein negativer Gesamtscore
      }

      // Aufräumen
      if (team.choices && team.choices.clear) team.choices.clear();
      if (team.rankSeq) team.rankSeq.length = 0;
    }

    state.committed = true;
    renderScoreboard(q); // sofort aktualisieren
  }
}

  else if (q.type === 'rank') {
  // Ranking: Punkte nur bei vollständig korrekter Reihenfolge
  if (!state.committed) {
    const N = Math.min(q.options.length, 6);

    // Anzeige-Reihenfolge vor Reveal = q.shuffle → mappe 1..N (Tasten/Buttons) -> Options-Indizes
    const dispOrder = (q.shuffle && q.shuffle.length) ? q.shuffle.slice(0, N) : [...Array(N).keys()];
    const dispToOpt = new Map(dispOrder.map((optIdx, i) => [i + 1, optIdx]));

    // Zielreihenfolge (Options-Indizes), sicherheitshalber auf N kürzen
    const target = (q.rankAnswer && q.rankAnswer.length) ? q.rankAnswer.slice(0, N) : [...Array(N).keys()];

    for (const team of state.teams) {
      const seq = Array.isArray(team.rankSeq) ? team.rankSeq.slice(0, N) : [];
      let ok = (seq.length === N);

      if (ok) {
        // Display-Nummern -> Options-Indizes (entspricht Button-Beschriftungen 1..N)
        const chosenOptIdxs = seq.map(d => dispToOpt.get(d));
        // exakte Übereinstimmung prüfen
        for (let i = 0; i < N; i++) {
          if (chosenOptIdxs[i] !== target[i]) { ok = false; break; }
        }
      }

      if (ok) {
        // Fix: immer +4 (unabhängig von POINTS), wie gewünscht
        team.score = (team.score || 0) + 4;
      }

      // Aufräumen
      if (team.rankSeq) team.rankSeq.length = 0;
      if (team.choices && team.choices.clear) team.choices.clear();
    }

    state.committed = true;

    // Punkte im Scoreboard sofort sichtbar machen
    renderScoreboard(q);
  }

  // Nach Reveal: richtige Reihenfolge zeigen
  renderOptionsOnly(q);
}

    else {
      const ob = byId('open-box');
      if (ob) ob.textContent = (q.answer && q.answer.trim()) ? q.answer : '—';
    }
  } else {
    // UNREVEAL
    if (q.type === 'mc') {
      [...byId('options').children].forEach(el => el.classList.remove('correct'));
    }
    else if (q.type === 'open') {
      const ob = byId('open-box');
      if (ob) ob.textContent = 'Schreibt eure Antwort auf!';
    }
    else if (q.type === 'rank') {
      renderOptionsOnly(q);
    }
  }
});

/* ========================== NAVIGATION ========================== */
byId('btn-prev').addEventListener('click',()=>{
  if(state.idx>0){
    state.idx--; state.reveal=false; state.committed=false;
    snapshotScores();
    renderQuestion();
  }
});

byId('btn-next').addEventListener('click',()=>{
  const last = state.idx >= state.questions.length - 1;

  // ► Einzelmodus: KEIN Zwischenstand, direkt weiter (bzw. Abschluss)
  if (state.mode === 'single') {
    if (last) {
      // Abschluss im Einzelmodus – z.B. Konfetti + kurzer Abschluss
      launchConfetti(3000);
      state.finished = true;
      renderWinnerBanner('Geschafft!'); // optional; kann auch entfernt werden
      return;
    }
    // direkt nächste Frage laden
    state.idx++;
    state.reveal = false;
    state.committed = false;
    snapshotScores();
    renderQuestion();
    return;
  }

  // ► Teammodus: Zwischenstand wie bisher
  if (last) {
    launchConfetti(5000);
    showStandingsOverlay({ isEnd: true });
    highlightWinnersOnScoreboard();
    return;
  }
  showStandingsOverlay({ isEnd: false });
});


function computeWinners(){ let max=-Infinity; for(const t of state.teams){ if(t.score>max) max=t.score; } return state.teams.filter(t=>t.score===max); }
function highlightWinnersOnScoreboard(){
  const winners=computeWinners();
  const names=new Set(winners.map(w=>w.name));
  const rows=[...byId('score-area').querySelectorAll('.team')];
  rows.forEach(row=>{
    const name=row.children[1].textContent;
    row.classList.toggle('winner', names.has(name));
  });
}

/* ========================== FULLSCREEN ========================== */
function isFullscreen(){return document.fullscreenElement!=null;}
function updateFSButtons(){
  const label=isFullscreen()?'⛶ Verlassen':'⛶ Vollbild';
  const title=isFullscreen()?'Vollbild verlassen':'Vollbild umschalten';
  byId('btn-fs-start').textContent=label; byId('btn-fs-start').title=title;
  byId('btn-fs-game').textContent=label;  byId('btn-fs-game').title=title;
}
function toggleFS(){ if(!isFullscreen()) document.documentElement.requestFullscreen?.(); else document.exitFullscreen?.(); }
byId('btn-fs-start').addEventListener('click',toggleFS);
byId('btn-fs-game').addEventListener('click',toggleFS);
document.addEventListener('fullscreenchange',updateFSButtons);

/* ========================== KEYBOARD ========================== */
document.addEventListener('keydown',(e)=>{
  const inGame = byId('screen-game').classList.contains('show');
  if(!inGame) return;

  if(e.key===' '||e.key==='Spacebar'){ e.preventDefault(); byId('btn-reveal').click(); }
  else if(e.key==='ArrowRight'){ byId('btn-next').click(); }
  else if(e.key==='ArrowLeft'){ byId('btn-prev').click(); }
  else{
    const q=state.questions[state.idx];
    if(!q || state.mode!=='team') return;

    if(q.type==='rank'){
      const num = parseInt(e.key,10);
      const N = Math.min(q.options.length,6);
      if(num>=1 && num<=N){ pushRankForActiveTeam(num,N); return; }
      if(e.key==='Backspace'){ e.preventDefault(); undoRankForActiveTeam(); return; }
      if(e.key==='c' || e.key==='C' || e.key==='Delete'){ clearRankForActiveTeam(); return; }
    }
  }
});
updateFSButtons();

/* ========================== CONFETTI ========================== */
let confettiRAF=null, confettiTtl=0, confettiStart=0, confettiParticles=[];
const confettiCanvas=byId('confetti'), ctx=confettiCanvas.getContext('2d');
function resizeConfetti(){confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight;}
addEventListener('resize',()=>{ if(confettiCanvas.classList.contains('show')) resizeConfetti(); });
function makeParticle(){
  const a=Math.random()*Math.PI - Math.PI/2, s=3+Math.random()*4, colors=['#f87171','#fb923c','#facc15','#34d399','#60a5fa','#a78bfa','#f472b6'];
  return {x:Math.random()*confettiCanvas.width,y:-20,vx:Math.cos(a)*s,vy:Math.sin(a)*s+2,g:.15+Math.random()*.25,w:6+Math.random()*6,h:8+Math.random()*10,rot:Math.random()*Math.PI,vr:(Math.random()-.5)*.2,color:colors[(Math.random()*colors.length)|0],alpha:1};
}
function stepConfetti(ts){
  if(!confettiStart) confettiStart=ts;
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  const elapsed=ts-confettiStart, spawn=elapsed<800?50:(elapsed<2000?25:10);
  for(let i=0;i<spawn;i++) confettiParticles.push(makeParticle());
  for(let i=confettiParticles.length-1;i>=0;i--){
    const p=confettiParticles[i];
    p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
    if(confettiTtl && performance.now()>confettiTtl-600) p.alpha=Math.max(0,p.alpha-.02);
    ctx.save(); ctx.globalAlpha=p.alpha; ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
    if(p.y>confettiCanvas.height+40||p.x<-40||p.x>confettiCanvas.width+40||p.alpha<=0) confettiParticles.splice(i,1);
  }
  if(performance.now()<confettiTtl || confettiParticles.length) confettiRAF=requestAnimationFrame(stepConfetti);
  else stopConfetti();
}
function launchConfetti(d=5000){resizeConfetti(); confettiCanvas.classList.add('show'); confettiParticles.length=0; confettiStart=0; confettiTtl=performance.now()+d; cancelAnimationFrame(confettiRAF); confettiRAF=requestAnimationFrame(stepConfetti);}
function stopConfetti(){cancelAnimationFrame(confettiRAF); confettiRAF=null; confettiCanvas.classList.remove('show'); ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); confettiParticles.length=0; confettiStart=0; confettiTtl=0;}

/* ========================== STANDINGS OVERLAY ========================== */
function showStandingsOverlay({isEnd=false}={}){
  const overlay=byId('standings'), list=byId('standings-list'); list.innerHTML='';

  if(isEnd){
    const winners=computeWinners();
    const t = winners.length===1 ? `✨ ${winners[0].name} ✨` : `✨ ${winners.map(w=>w.name).join(' & ')} ✨`;
    byId('standings-title').textContent = t;
  }else{
    byId('standings-title').textContent = 'Zwischenstand';
  }

  byId('standings-continue').style.display = isEnd ? 'none' : 'inline-block';
  byId('standings-exit').style.display = isEnd ? 'inline-block' : 'none';

  const prev = state.teams.map((t,i)=>({i,name:t.name,color:t.color,prev:state.scoresStartRound[i]||0,now:t.score}));
  prev.sort((a,b)=> b.prev - a.prev || a.name.localeCompare(b.name));

  prev.forEach((t,idx)=>{
    const item=document.createElement('div'); item.className='standing-item'; item.dataset.index=t.i;
    item.style.background = hexWithAlpha(t.color,.25);
    item.style.transitionDuration = STANDINGS_FLIP_MS+'ms';
    item.innerHTML=
      `<div class="standing-rank">${idx+1}</div>
       <div class="standing-name">${t.name}</div>
       <div class="standing-score" data-score="${t.prev}">${t.prev}</div>`;
    list.appendChild(item);
  });

  overlay.classList.add('show');

  // Count-up
  const items=[...list.children];
  items.forEach((el)=>{
    const idx=parseInt(el.dataset.index,10);
    const target=state.teams[idx].score;
    const scoreEl=el.querySelector('.standing-score');
    const start=parseInt(scoreEl.dataset.score,10);
    animateCount(scoreEl,start,target,STANDINGS_COUNT_MS);
  });

  // FLIP
  setTimeout(()=>{
    const firstRects=items.map(el=>el.getBoundingClientRect());

    const ordered=items.slice().sort((A,B)=>{
      const ai=parseInt(A.dataset.index,10), bi=parseInt(B.dataset.index,10);
      const as=state.teams[ai].score, bs=state.teams[bi].score;
      if(bs!==as) return bs-as;
      const an=A.querySelector('.standing-name').textContent;
      const bn=B.querySelector('.standing-name').textContent;
      return an.localeCompare(bn);
    });

    ordered.forEach(el=>list.appendChild(el));

    const lastRects=ordered.map(el=>el.getBoundingClientRect());
    ordered.forEach((el,k)=>{
      const first=firstRects[items.indexOf(el)];
      const last=lastRects[k];
      const dy=first.top - last.top;
      el.style.transform=`translateY(${dy}px)`;
      el.getBoundingClientRect();
      el.style.transition=`transform ${STANDINGS_FLIP_MS}ms ease`;
      el.style.transform='translateY(0)';
    });

    setTimeout(()=>{
      const winners=computeWinners();
      const winnerNames=new Set(winners.map(w=>w.name));
      [...list.children].forEach((el,i)=>{
        el.querySelector('.standing-rank').textContent=String(i+1);
        const name=el.querySelector('.standing-name').textContent;
        el.classList.toggle('winner', winnerNames.has(name));
      });
      if(isEnd){
        highlightWinnersOnScoreboard();
      }
    }, STANDINGS_AFTER_MS);

  }, STANDINGS_PREP_MS);

  byId('standings-continue').onclick=()=>{
    overlay.classList.remove('show');
    snapshotScores();
    state.idx++; state.reveal=false; state.committed=false; state.activeTeamIndex=0;
    renderQuestion();
  };

  byId('standings-exit').onclick=()=>{
    location.reload(); // harter Neustart
  };
}

function animateCount(el,from,to,dur){
  const start=performance.now();
  function step(ts){
    const t=Math.min(1,(ts-start)/dur);
    const val=Math.round(from + (to-from)*t);
    el.textContent=val;
    if(t<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ========================== RESET ========================== */
function resetAll(){
  state.mode=null;
  state.questions=[]; state.idx=0; state.reveal=false; state.teams=[]; state.committed=false; state.finished=false; state.scoresStartRound=[];
  state.activeTeamIndex=0;
  byId('screen-game').classList.remove('show');
  byId('screen-start').classList.add('show');

  byId('tile-single').classList.remove('selected');
  byId('tile-team').classList.remove('selected');
  byId('team-config').style.display='none';
  byId('fileInput').value='';

  renderWinnerBanner('');
  byId('standings').classList.remove('show');
  stopConfetti();
  updateFSButtons();
}

/* ========================== SAMPLE ========================== */
function sampleText(){
  return [
    'TYPE: mc',
    'TAG: Verträge',
    'Q: Ab welchem Alter ist man in Deutschland voll geschäftsfähig?',
    'OPT: 14 Jahre',
    'OPT: 16 Jahre',
    '*OPT: 18 Jahre',
    'OPT: 21 Jahre',
    'POINTS: 1',
    '',
    'TYPE: mc',
    'TAG: Geometrie',
    'Q: Welche Aussagen sind richtig? (Mehrfachauswahl)',
    '*OPT: Summe der Innenwinkel im Dreieck = 180°',
    '*OPT: Ein Quadrat ist ein spezielles Rechteck',
    'OPT: Alle Parallelogramme sind Quadrate',
    'OPT: Jede Raute ist ein Kreis',
    'OPT: ',
    'OPT: ',
    'POINTS: 1',
    '',
    'TYPE: rank',
    'TAG: Geschichte',
    'Q: Ordne chronologisch (früh → spät).',
    'OPT: PLAZTHALTER',
    'OPT: PLATZHALTer',
    'OPT: Platz 3',
    'OPT: Platz 4',
    'OPT: Platz 5',
    'OPT: Platz 6',
    'ANSWER: 1,2,3,4,5,6',
    'POINTS: 4'
  ].join('\\n');
}

/* ========================== INIT ========================== */
renderTeamInputs();
updateFSButtons();
</script>
</body>
</html>
